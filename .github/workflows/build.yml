name: ULTIMATE CLEAN BUILD

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    name: Build Aura AI
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ”¥ NUCLEAR CLEAN - Remove EVERYTHING
        run: |
          echo "=== Cleaning ALL caches ==="
          rm -rf ~/.gradle
          rm -rf .gradle
          rm -rf app/build
          rm -rf ~/.android/cache
          rm -rf ~/.m2
          rm -rf ~/.cache
          echo "âœ… Clean complete"

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: ðŸ“‹ DEBUG - Show file contents
        run: |
          echo "=== Current Directory ==="
          pwd
          echo "=== Directory Structure ==="
          find app/src/main/java/com/aura/ai -type f -name "*.kt" | sort
          echo ""
          echo "=== ChatActivity.kt Line 9 ==="
          sed -n '9p' app/src/main/java/com/aura/ai/presentation/activities/ChatActivity.kt 2>/dev/null || echo "File not found"
          echo ""
          echo "=== Extensions.kt Content ==="
          cat app/src/main/java/com/aura/ai/utils/Extensions.kt 2>/dev/null || echo "Extensions.kt not found"
          echo ""
          echo "=== Activity Imports Check ==="
          grep -l "import androidx.activity.viewModels" app/src/main/java/com/aura/ai/presentation/activities/*.kt || echo "Missing viewModels import in some activities"

      - name: ðŸ—ï¸ BUILD APK - Fresh
        run: |
          echo "=== Running clean ==="
          ./gradlew clean
          echo "=== Building debug APK ==="
          ./gradlew assembleDebug --stacktrace --no-build-cache --no-configuration-cache --refresh-dependencies
        continue-on-error: false

      - name: ðŸ“¦ UPLOAD APK
        uses: actions/upload-artifact@v4
        with:
          name: AuraAI-Debug
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error
          retention-days: 90

      - name: âœ… Build Summary
        run: |
          echo "## ðŸš€ Aura AI Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
            SIZE=$(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)
            echo "âœ… **BUILD SUCCESSFUL!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“± **APK Size:** $SIZE" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Location:** app/build/outputs/apk/debug/app-debug.apk" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **BUILD FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the build logs above for errors." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
